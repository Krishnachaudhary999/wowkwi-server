<!DOCTYPE html>
<html>
<head>
    <title>Weather Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.socket.io/4.7.1/socket.io.min.js"></script>
</head>
<body>
    <h1>Weather Dashboard</h1>
    <canvas id="tempChart" width="600" height="300"></canvas>
    <canvas id="humChart" width="600" height="300"></canvas>

    <script>
        const tempCtx = document.getElementById('tempChart').getContext('2d');
        const humCtx = document.getElementById('humChart').getContext('2d');

        let labels = [];
        let tempData = [];
        let humData = [];

        const tempChart = new Chart(tempCtx, {
            type: 'line',
            data: { labels, datasets: [{ label: 'Temperature Â°C', data: tempData, borderColor: 'red', fill: false }] },
            options: { responsive: true }
        });

        const humChart = new Chart(humCtx, {
            type: 'line',
            data: { labels, datasets: [{ label: 'Humidity %', data: humData, borderColor: 'blue', fill: false }] },
            options: { responsive: true }
        });

        async function fetchRecent() {
            const res = await fetch('/api/recent?n=10');
            const data = await res.json();
            labels = data.map(d => new Date(d.timestamp).toLocaleTimeString()).reverse();
            tempData = data.map(d => d.temperature).reverse();
            humData = data.map(d => d.humidity).reverse();
            tempChart.data.labels = labels;
            tempChart.data.datasets[0].data = tempData;
            humChart.data.labels = labels;
            humChart.data.datasets[0].data = humData;
            tempChart.update();
            humChart.update();
        }

        fetchRecent();

        const socket = io();
        socket.on('new_data', (d) => {
            labels.push(new Date(d.timestamp).toLocaleTimeString());
            tempData.push(d.temperature);
            humData.push(d.humidity);
            if (labels.length > 10) { labels.shift(); tempData.shift(); humData.shift(); }
            tempChart.update();
            humChart.update();
        });
    </script>
</body>
</html>
